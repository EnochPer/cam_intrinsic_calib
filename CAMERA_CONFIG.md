# 相机参数配置说明

## 相机硬件规格

本标定工具已针对以下相机规格进行优化：

```
┌──────────────────────────────────────┐
│      相机硬件规格 (Sony IMX264)      │
├──────────────────────────────────────┤
│ 型号:           Sony IMX264          │
│ 分辨率:         2448 × 2048 像素     │
│ 像元尺寸:       3.45 × 3.45 μm       │
│ 靶面尺寸:       2/3"                 │
│ 传感器宽度:     8.4456 mm            │
│ 传感器高度:     7.0656 mm            │
│ 镜头焦距:       6mm                  │
│ 标定板规格:     12×9 棋盘格         │
└──────────────────────────────────────┘
```

## 理论焦距计算

### 公式

$$f_{\text{px}} = \frac{F_{\text{mm}} \times W_{\text{px}}}{S_{\text{mm}}}$$

### 参数说明

| 符号 | 含义 | 值 | 单位 |
|------|------|-----|------|
| $f_{\text{px}}$ | 焦距（像素） | ? | px |
| $F_{\text{mm}}$ | 镜头焦距（标称） | 6 | mm |
| $W_{\text{px}}$ | 图像宽度 | 2448 | px |
| $S_{\text{mm}}$ | 传感器宽度 | 8.4456 | mm |

### 计算推导

**Sony IMX264 的传感器宽度计算：**
```
分辨率 (水平): 2448 px
像元尺寸: 3.45 μm = 3.45 × 10⁻³ mm
传感器宽度 = 2448 × 3.45 × 10⁻³ = 8.4456 mm
```

### 计算结果

$$f = \frac{6 \times 2448}{8.4456} = 1739.13 \text{ px}$$

**理论焦距：约 1739.13 像素**

## 焦距期望范围

| 范围类型 | 值 | 说明 |
|---------|-----|------|
| **理论值** | **1739.13 px** | 最可能的值 |
| **期望范围 (±5%)** | **1652.2 - 1826.1 px** | 标定结果应落在此范围 |
| **广泛范围 (0.8-1.5×宽)** | **1958.4 - 3672.0 px** | 异常检测的广泛边界 |

### 焦距评估标准

| 焦距范围 | 评级 | 说明 |
|---------|------|------|
| 1739.13 ± 52.2 px | ⭐⭐⭐⭐⭐ 优秀 | ±3% 内，标定精度极高 |
| 1739.13 ± 130.6 px | ⭐⭐⭐⭐ 良好 | ±7.5% 内，标定精度良好 |
| 1652.2 - 1826.1 px | ⭐⭐⭐⭐ 良好 | ±5% 内，标定精度良好 |
| 1958.4 - 3672.0 px | ⭐⭐⭐ 可接受 | 在广泛范围内，可用 |
| 外范围 | ⭐⭐ 需要检查 | 建议重新标定 |

## 等效焦距验证

标定程序会自动计算**等效焦距（毫米）**用于验证：

$$f_{\text{mm}} = f_{\text{px}} \times \frac{S_{\text{mm}}}{W_{\text{px}}} = f_{\text{px}} \times \frac{8.4456}{2448}$$

### 验证标准

| 差异范围 | 精度评级 | 状态 |
|---------|---------|------|
| < 0.3 mm | 优秀 | ✅ 标定结果非常可靠 |
| 0.3 - 0.8 mm | 良好 | ✅ 标定结果可靠 |
| 0.8 - 1.5 mm | 可接受 | ⚠️ 标定结果可用但需监测 |
| > 1.5 mm | 需要检查 | ❌ 建议重新采集或调整参数 |

## 校验机制

### 自动校验项

程序运行时会自动进行以下校验：

#### 1. 焦距范围检查（两层机制）

**严格范围** (±5%)：检测标定异常
```
期望: 1652.2 - 1826.1 px
作用: 检测明显的标定偏差
```

**广泛范围** (0.8-1.5×)：确保数据可用
```
期望: 1958.4 - 3672.0 px
作用: 允许某些应用场景的偏差
```

#### 2. 等效焦距检查
```
标定得到的等效焦距应接近 6mm（镜头标称焦距）
差异评估: < 0.3mm (优), < 0.8mm (良好), < 1.5mm (可接受)
```

#### 3. 光心位置检查
```
✓ cx 应在 244.8 - 2203.2 px（10%-90% 范围）
✓ cy 应在 204.8 - 1843.2 px（10%-90% 范围）
```

#### 4. 重投影误差检查
```
✓ RMS < 0.5px:     优秀 ⭐⭐⭐⭐⭐
✓ RMS < 1.0px:     良好 ⭐⭐⭐⭐
✓ RMS < 2.0px:     可接受 ⭐⭐⭐
✗ RMS > 2.0px:     需要改进 ⭐⭐
```

#### 5. 畸变系数检查
```
✓ |k1|, |k2|, |k3| 通常 < 1.0
✓ |p1|, |p2| 通常 < 0.1
```

## 代码配置

### 算法参数位置

在 `src/calibrate_camera.cpp` 中设置（第 ~50-80 行）：

```cpp
// 相机分辨率（像素）
static const int CAMERA_WIDTH = 2448;
static const int CAMERA_HEIGHT = 2048;

// 镜头焦距（毫米）
static const float LENS_FOCAL_LENGTH_MM = 6.0f;

// Sony IMX264 传感器尺寸
// 计算: 像元尺寸(μm) × 分辨率(px) / 1000
static const float SENSOR_WIDTH_MM = 8.4456f;   // 3.45 × 2448 / 1000
static const float SENSOR_HEIGHT_MM = 7.0656f;  // 3.45 × 2048 / 1000

// 焦距期望范围（±5%）
// 理论值: 6.0 × 2448 / 8.4456 = 1739.13 px
static const float EXPECTED_FOCAL_LENGTH_MIN = 1652.2f;
static const float EXPECTED_FOCAL_LENGTH_MAX = 1826.1f;
static const float EXPECTED_FOCAL_LENGTH_MIN_Y = 1652.2f;
static const float EXPECTED_FOCAL_LENGTH_MAX_Y = 1826.1f;
```

## 修改相机参数

如果需要针对不同的相机规格进行标定，修改以下常量：

### 步骤 1: 确定相机规格

确认以下参数（通常从相机手册获取）：
- 分辨率 (宽 × 高)
- 像元尺寸 (μm)
- 镜头焦距 (mm)

### 步骤 2: 计算传感器尺寸

```python
# Python 快速计算
pixel_size = 3.45  # μm
width_px = 2448
height_px = 2048

sensor_width_mm = (width_px * pixel_size) / 1000
sensor_height_mm = (height_px * pixel_size) / 1000

print(f"Sensor Width: {sensor_width_mm} mm")
print(f"Sensor Height: {sensor_height_mm} mm")
```

### 步骤 3: 修改代码

```cpp
// 1. 修改分辨率
static const int CAMERA_WIDTH = 2448;    // 改成实际分辨率
static const int CAMERA_HEIGHT = 2048;   // 改成实际分辨率

// 2. 修改镜头焦距
static const float LENS_FOCAL_LENGTH_MM = 6.0f;  // 改成实际焦距

// 3. 修改传感器尺寸
static const float SENSOR_WIDTH_MM = 8.4456f;    // 改成计算结果
static const float SENSOR_HEIGHT_MM = 7.0656f;   // 改成计算结果

// 4. 重新计算焦距范围
// 理论焦距 = 镜头焦距 × 分辨率宽度 / 传感器宽度
// 期望范围 = 理论焦距 ± 5%
```

### 步骤 4: 重新编译

```bash
colcon build --packages-select cam_intrinsic_calib
```

## 常见场景

### 场景 1: 标定结果焦距为 1739px，合理吗？

**答**: 是的，非常合理！
- 理论值：1739.13 px
- 标定值：1739 px
- 偏差：-0.13 px（等效焦距差异 < 0.001mm）
- **结论**: ✅ 优秀

### 场景 2: 标定结果焦距为 1700px，怎么样？

**答**: 良好，可以接受。
- 理论值：1739.13 px
- 标定值：1700 px
- 偏差：-39.13 px（等效焦距差异 -0.14mm）
- **状态**: ⭐⭐⭐⭐ 良好
- **结论**: ✅ 标定结果可靠

### 场景 3: 标定结果焦距为 1600px，有问题吗？

**答**: 需要检查。
- 理论值：1739.13 px
- 标定值：1600 px
- 偏差：-139.13 px（等效焦距差异 -0.50mm）
- **状态**: ⭐⭐⭐ 可接受（但接近边界）
- **建议**: ⚠️ 检查采集图像的质量或棋盘格规格

### 场景 4: 标定结果焦距为 2200px，怎么办？

**答**: 需要验证和重新标定。
- 理论值：1739.13 px
- 标定值：2200 px
- 偏差：+460.87 px（等效焦距差异 +1.66mm）
- **原因可能**: 
  - 采集的图像分辨率与实际不同
  - 棋盘格规格错误
  - 镜头焦距设置错误
- **建议**: ❌ 重新检查参数，重新采集标定图像

## 参考资源

### 传感器尺寸标准

| 传感器规格 | 尺寸（mm） | 说明 |
|----------|-----------|------|
| 1" | 12.8 × 9.6 | 大型传感器 |
| 2/3" | 8.8 × 6.6 | 工业标准 |
| 1/1.2" | 8.0 × 6.0 | 常见规格 |
| 1/1.3" | 6.4 × 4.8 | 早期工业相机 |
| **2/3"** | **8.8 × 6.6** | **Sony IMX264** |
| 1/1.5" | 5.3 × 4.0 | 小型相机 |
| 1/2" | 4.4 × 3.3 | 网络摄像头 |

### Sony IMX264 完整规格

```
传感器名称:    Sony IMX264
分辨率:        2448(H) × 2048(V)
像元尺寸:      3.45 μm × 3.45 μm (方形)
靶面尺寸:      2/3" (Exmor™ CMOS)
有效靶面:      8.4456 mm (H) × 7.0656 mm (V)
帧率:          部分可配置
输出:          LVDS / MIPI CSI-2
光谱响应:      可见光
应用:          工业相机，机器视觉
```

### 焦距与视场角关系

$$\text{FOV} = 2 \times \arctan\left(\frac{\text{Sensor Width}}{2 \times f_{\text{mm}}}\right)$$

**本相机的视场角：**
$$\text{FOV} = 2 \times \arctan\left(\frac{8.4456}{2 \times 6}\right) \approx 75.6°$$

## 更新日志

| 版本 | 日期 | 更改 |
|------|------|------|
| 1.2 | 2025-11-14 | 更新为 Sony IMX264，精确传感器参数，改进焦距校验机制 |
| 1.1 | 2025-11-14 | 添加相机参数优化，实现自动校验 |
| 1.0 | 2025-11-13 | 初始版本 |

---

**最后更新**: 2025 年 11 月 14 日
